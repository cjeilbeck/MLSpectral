import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.svm import SVC
from sklearn.decomposition import PCA              
from sklearn.pipeline import Pipeline            
from sklearn.metrics import accuracy_score, classification_report
import matplotlib.pyplot as plt  
from scipy.signal import savgol_filter
from sklearn.preprocessing import FunctionTransformer
from A_functions import haircut,read_data,multispectral,indicesmav
import numpy as np
import seaborn as sns
from sklearn.model_selection import GridSearchCV
def apply_savgol(x):
    return savgol_filter(x, window_length=51, polyorder=3, axis=1)

USE_SCALING = True
USE_PCA = False
USE_SAVGOL = True
HAIRCUT = True 
z = 42  # Seed
comp = 4 # PCA components
left= 200
right=900
#3648 wavelength values for reference, 345 - 1038nm

test_sizeinput = 0.2
MULTIREGION = False
centers = [560,650, 730,860]  
width = [32,32,32,26]

INDICES = False # does not work for SVM yet will figure it out

KERNEL = 'linear' #try 'linear', 'poly', 'rbf', 'sigmoid'   linear performs best on spectral, rbf maybe multispectral
C = 1.0        # regularization
GAMMA = 'scale' # kernel coefficient 

x,y=read_data("CSVfiles/datacalibrated.csv")

if HAIRCUT:
    x = haircut(x,left,right)
    print(f"trimmed wav:",x.columns[0],x.columns[-1])
if MULTIREGION:
    x = multispectral(x, centers, width)
if INDICES:
    x = indicesmav(x)
x_train,x_test,y_train,y_test = train_test_split(x,y,test_size=test_sizeinput,random_state=z,stratify=y)

pipeline_steps = []

if USE_SAVGOL:
    pipeline_steps.append(('savgol', FunctionTransformer(apply_savgol)))

if USE_SCALING:
    pipeline_steps.append(('scaler', StandardScaler()))

if USE_PCA:
    pipeline_steps.append(('pca', PCA(n_components=comp)))

pipeline_steps.append(('svm_model', SVC(kernel=KERNEL, C=C, gamma=GAMMA)))
model = Pipeline(pipeline_steps)


params = {'svm_model__kernel': ['rbf','linear','sigmoid','poly'],
    'svm_model__C': [1,1e2,1e3,1e4,1e5,1e6],
    'svm_model__gamma': [1]}

    
grid = GridSearchCV(model, param_grid=params, refit=True, verbose=2, cv=5, n_jobs=-1)
grid.fit(x_train, y_train)
print(f"best accuracy: {grid.best_score_:.4f}")
print(f"best parameters: {grid.best_params_}")
results_df = pd.DataFrame(grid.cv_results_)
heatmap_data = results_df
pivot_table = heatmap_data.pivot(index='param_svm_model__C', columns='param_svm_model__kernel', values='mean_test_score')

plt.figure(figsize=(10, 8))
sns.heatmap(pivot_table, annot=True, cmap='viridis', fmt=".3f")
plt.ylabel('C Parameter')
plt.xlabel('Kernel Type')
plt.show()